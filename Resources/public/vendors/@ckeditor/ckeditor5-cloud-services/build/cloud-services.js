/*!
 * @license Copyright (c) 2003-2021, CKSource - Frederico Knabben. All rights reserved.
 * For licensing, see LICENSE.md.
 */
window.CKEditor5=window.CKEditor5||{},window.CKEditor5.cloudServices=function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=3)}([function(e,t,r){e.exports=r(2)("./src/utils.js")},function(e,t,r){e.exports=r(2)("./src/core.js")},function(e,t){e.exports=CKEditor5.dll},function(e,t,r){"use strict";r.r(t);var n=r(1),o=r(0);const s={autoRefresh:!0};class i{constructor(e,t=s){if(!e)throw new o.CKEditorError("token-missing-token-url",this);t.initValue&&this._validateTokenValue(t.initValue),this.set("value",t.initValue),this._refresh="function"==typeof e?e:()=>{return t=e,new Promise((e,r)=>{const n=new XMLHttpRequest;n.open("GET",t),n.addEventListener("load",()=>{const t=n.status,s=n.response;return t<200||t>299?r(new o.CKEditorError("token-cannot-download-new-token",null)):e(s)}),n.addEventListener("error",()=>r(new Error("Network Error"))),n.addEventListener("abort",()=>r(new Error("Abort"))),n.send()});var t},this._options=Object.assign({},s,t)}init(){return new Promise((e,t)=>{this.value?(this._options.autoRefresh&&this._registerRefreshTokenTimeout(),e(this)):this.refreshToken().then(e).catch(t)})}refreshToken(){return this._refresh().then(e=>{this._validateTokenValue(e),this.set("value",e),this._options.autoRefresh&&this._registerRefreshTokenTimeout()}).then(()=>this)}destroy(){clearTimeout(this._tokenRefreshTimeout)}_validateTokenValue(e){const t="string"==typeof e,r=!/^".*"$/.test(e),n=t&&3===e.split(".").length;if(!r||!n)throw new o.CKEditorError("token-not-in-jwt-format",this)}_registerRefreshTokenTimeout(){const e=this._getTokenRefreshTimeoutTime();clearTimeout(this._tokenRefreshTimeout),this._tokenRefreshTimeout=setTimeout(()=>{this.refreshToken()},e)}_getTokenRefreshTimeoutTime(){try{const[,e]=this.value.split("."),{exp:t}=JSON.parse(atob(e));if(!t)return 36e5;return Math.floor((1e3*t-Date.now())/2)}catch(e){return 36e5}}static create(e,t=s){return new i(e,t).init()}}Object(o.mix)(i,o.ObservableMixin);var a=i;const u=/^data:(\S*?);base64,/;class l{constructor(e,t,r){if(!e)throw new o.CKEditorError("fileuploader-missing-file",null);if(!t)throw new o.CKEditorError("fileuploader-missing-token",null);if(!r)throw new o.CKEditorError("fileuploader-missing-api-address",null);this.file=function(e){if("string"!=typeof e)return!1;const t=e.match(u);return!(!t||!t.length)}(e)?function(e,t=512){try{const r=e.match(u)[1],n=atob(e.replace(u,"")),o=[];for(let e=0;e<n.length;e+=t){const r=n.slice(e,e+t),s=new Array(r.length);for(let e=0;e<r.length;e++)s[e]=r.charCodeAt(e);o.push(new Uint8Array(s))}return new Blob(o,{type:r})}catch(e){throw new o.CKEditorError("fileuploader-decoding-image-data-error",null)}}(e):e,this._token=t,this._apiAddress=r}onProgress(e){return this.on("progress",(t,r)=>e(r)),this}onError(e){return this.once("error",(t,r)=>e(r)),this}abort(){this.xhr.abort()}send(){return this._prepareRequest(),this._attachXHRListeners(),this._sendRequest()}_prepareRequest(){const e=new XMLHttpRequest;e.open("POST",this._apiAddress),e.setRequestHeader("Authorization",this._token.value),e.responseType="json",this.xhr=e}_attachXHRListeners(){const e=this,t=this.xhr;function r(t){return()=>e.fire("error",t)}t.addEventListener("error",r("Network Error")),t.addEventListener("abort",r("Abort")),t.upload&&t.upload.addEventListener("progress",e=>{e.lengthComputable&&this.fire("progress",{total:e.total,uploaded:e.loaded})}),t.addEventListener("load",()=>{const e=t.status,r=t.response;if(e<200||e>299)return this.fire("error",r.message||r.error)})}_sendRequest(){const e=new FormData,t=this.xhr;return e.append("file",this.file),new Promise((r,n)=>{t.addEventListener("load",()=>{const e=t.status,s=t.response;return e<200||e>299?s.message?n(new o.CKEditorError("fileuploader-uploading-data-failed",this,{message:s.message})):n(s.error):r(s)}),t.addEventListener("error",()=>n(new Error("Network Error"))),t.addEventListener("abort",()=>n(new Error("Abort"))),t.send(e)})}}Object(o.mix)(l,o.EmitterMixin);class d{constructor(e,t){if(!e)throw new o.CKEditorError("uploadgateway-missing-token",null);if(!t)throw new o.CKEditorError("uploadgateway-missing-api-address",null);this._token=e,this._apiAddress=t}upload(e){return new l(e,this._token,this._apiAddress)}}class h extends n.ContextPlugin{static get pluginName(){return"CloudServicesCore"}createToken(e,t){return new a(e,t)}createUploadGateway(e,t){return new d(e,t)}}class c extends n.ContextPlugin{static get pluginName(){return"CloudServices"}static get requires(){return[h]}init(){const e=this.context.config.get("cloudServices")||{};for(const t in e)this[t]=e[t];if(this._tokens=new Map,this.tokenUrl)return this.token=this.context.plugins.get("CloudServicesCore").createToken(this.tokenUrl),this._tokens.set(this.tokenUrl,this.token),this.token.init();this.token=null}registerTokenUrl(e){if(this._tokens.has(e))return Promise.resolve(this.getTokenFor(e));const t=this.context.plugins.get("CloudServicesCore").createToken(e);return this._tokens.set(e,t),t.init()}getTokenFor(e){const t=this._tokens.get(e);if(!t)throw new o.CKEditorError("cloudservices-token-not-registered",this);return t}destroy(){super.destroy();for(const e of this._tokens.values())e.destroy()}}t.default={CloudServices:c,CloudServicesCore:h}}]).default;